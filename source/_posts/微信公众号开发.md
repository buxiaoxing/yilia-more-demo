---
title: 微信公众号开发
date: 2022-06-10 17:28:52
tags: WeChat
---

### 微信鉴权

[https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html)

<!--more-->

- js接口安全域名

  `进入公众号后台-->设置与开发-->公众号设置-->功能设置`

- ip白名单

  `设置与开发-->基本配置/安全中心`

- 启用服务器配置

  `设置与开发-->基本配置`

  ```js
  router.get('/auth', (req, res)=>{
    console.log(req)
    let {signature, timestamp, nonce, echostr} = req.query
    let token = 'peter'
    let arr = [timestamp, nonce, token]
    arr.sort()  // 字典排序
    let str = arr.join('')
    let result = sha1(str) // sha1加密
    if(result === signature){
      res.set('Content-Type', 'text/plain')
      res.send(echostr)
    }else{
      res.send === ('Error!!!')
    }
  })
  ```

- jsapi授权

  - 获取appid 和 appsecret

    `设置与开发基本配置`

  - 获取签名

    ```js
    const { appid, secret } = require('../config/index')
    const axios = require('axios')
    const sha1 = require('sha1')
    
    async function getTicket() {
      // 获取 access_token
      let tokenUrl = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${appid}&secret=${secret}`
      const tokenData = await axios.get(tokenUrl)
      console.log(tokenData)
      const {access_token} = tokenData.data
    
      // 获取 ticket 签名
      let ticketUrl = `https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=${access_token}&type=jsapi`
      const ticketData = await axios.get(ticketUrl)
      console.log(ticketData)
      const { ticket } = ticketData.data
      return ticket
    }
    
    const createNonceStr = ()=>{ // 生成随机字符串
      return Math.random().toString(36).substring(2,15)
    }
    
    const createTimestamp = ()=>{ // 生成时间戳
      return parseInt(new Date().getTime() / 1000) + ''
    }
    
    
    
    /**
     * get signature
     * @param {*} url 
     * @returns 
     */
    const sign = async (url) => {
      const jsapi_ticket = await getTicket()
      const obj = {
        jsapi_ticket,
        noncestr: createNonceStr(),
        timestamp: createTimestamp(),
        url,
      }
      const signature = sha1(objToString(obj))
    
      obj.signature = signature
      obj.appid = appid
    
      return obj
    
    }
    
    /**
     * props sort to string like 'key = val & key2 = val2'
     * @param {*} obj 
     * @returns 
     */
    function objToString(obj){
      var keys = Object.keys(obj)
      keys = keys.sort()
      var newObj = {}
      keys.forEach(prop=>{
        newObj[prop] = obj[prop]
      })
      var string = ''
      for( k in newObj){
        string += '&' + k + '=' + newObj[k]
      }
    
      string = string.substring(1)
      return string
    }
    
    module.exports = sign
    ```

  - 请求授权

    ```js
    <html>
    
    <head>
      <title>Express</title>
      <link rel="stylesheet" href="/stylesheets/style.css">
      <script src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
      <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    
      <script src=""></script>
    </head>
    
    <body>
      <div id="app">
        <h1>Express</h1>
        <p @click="scanQRCode">Welcome to Express</p>
      </div>
      <script>
        new Vue({
          el: '#app',
          mounted() {
            this.wxconfig()
          },
          methods: {
            wxconfig() {
              const url = encodeURIComponent(location.href.split('#')[0])
              axios.get(`http://test.buxiaoxing.com/jsapi?url=${url}`).then((res) => {
                const {
                  appid,
                  noncestr,
                  timestamp,
                  signature
                } = res.data
                wx.config({
                  debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                  appId: appid, // 必填，公众号的唯一标识
                  timestamp, // 必填，生成签名的时间戳
                  nonceStr: noncestr, // 必填，生成签名的随机串
                  signature, // 必填，签名
                  jsApiList: [
                    'scanQRCode',
                  ] // 必填，需要使用的JS接口列表
                });
              }).catch(err => {
                console.log(err)
              })
            },
    
            scanQRCode() {
              wx.scanQRCode({
                needResult: 0, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                scanType: ["qrCode", "barCode"], // 可以指定扫二维码还是一维码，默认二者都有
                success: function (res) {
                  var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                }
              });
            }
          }
        })
      </script>
    </body>
    
    </html>
    ```
